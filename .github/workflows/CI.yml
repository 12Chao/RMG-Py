name: Constant Integration

on:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron: "0 8 * * *"
  push:

# this prevents one PR from simultaneously running multiple runners, which will clog up the queue
# and prevent other PRs from running the CI
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test-linux:
    runs-on: ubuntu-latest
    env: # update this if needed to match a pull request on the RMG-database
      RMG_DATABASE_BRANCH: main
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - uses: actions/checkout@v2

      # configures the mamba environment manager and build the environment
      - name: Setup mamba with Python 3.7 and Build Environment
        uses: conda-incubator/setup-miniconda@v2
        with:
          environment-file: environment.yml
          miniforge-variant: Mambaforge
          miniforge-version: latest
          python-version: 3.7
          activate-environment: rmg_env
          use-mamba: true

      # list the environment for debugging purposes
      - name: mamba info
        run: |
          mamba info
          mamba list

      # Clone the other needed repository
      - name: Clone RMG-Database
        run: |
          cd ..
          git clone -b $RMG_DATABASE_BRANCH https://github.com/ReactionMechanismGenerator/RMG-database.git
          
      # modify env variables as directed in the RMG installation instructions
      - name: Set PYTHONPATH and PATH
        run: |
          RUNNER_CWD=$(pwd)
          echo "PYTHONPATH=$RUNNER_CWD/RMG-Py:$PYTHONPATH" >> $GITHUB_ENV
          echo "$RUNNER_CWD/RMG-Py" >> $GITHUB_PATH

      # RMG build step
      - name: make RMG
        run: |
          make clean
          make

      # RMS installation and linking to Julia
      # Allow these installs to 'fail' (as they do in RMG-Tests) with the command || True trick
      - name: Install and link Julia dependencies
        run: |
          python -c "import julia; julia.install(); import diffeqpy; diffeqpy.install()" || true
          julia -e 'using Pkg; Pkg.add(PackageSpec(name="ReactionMechanismSimulator",rev="main")); using ReactionMechanismSimulator' || true 
          ln -sfn $(which python-jl) $(which python)

      # Attempt to install MOPAC
      - name: Install MOPAC
        env:
          MOPACKEY: ${{ secrets.MOPACKEY }}
        timeout-minutes: 1
        continue-on-error: true # allowed to fail on pull request from a forked repository
        run: |
          set +o pipefail
          yes 'Yes' | ${CONDA_PREFIX}/bin/mopac "$MOPACKEY"

      # non-regression testing
      - name: Unit tests
        run: make test-unittests
      - name: Functional tests
        run: make test-functional
      - name: Database tests
        run: make test-database

      # Regression Testing - Test Execution
      - name: Regression Tests - Execution
        run: |
          timeout 600 python-jl rmg.py test/regression/aromatics/input.py
          # ./run.sh test/regression/nitrogen
          # nitrogen_status=$?
          # ./run.sh test/regression/sulfur
          # sulfur_status=$?
          # ./run.sh test/regression/oxidation
          # oxidation_status=$?
          # ./run.sh test/regression/liquid_oxidation
          # liquid_oxidation_status=$?
          # ./run.sh test/regression/superminimal
          # superminimal_status=$?
          # ./run.sh test/regression/eg1
          # eg1_status=$?

          # echo "aromatics status: $aromatics_status"
          # echo "nitrogen status: $nitrogen_status"
          # echo "sulfur status: $sulfur_status"
          # echo "oxidation status: $oxidation_status"
          # echo "liquid oxidation status: $liquid_oxidation_status"
          # echo "superminimal status: $superminimal_status"
          # echo "eg1 status: $eg1_status"
          # if [ $(($aromatics_status | $nitrogen_status | $sulfur_status | $oxidation_status | $liquid_oxidation_status | $superminimal_status | $eg1_status)) -ne 0 ];
          # then
          #   echo "Failed regression tests (non-zero exit code from regression test)"
          #   exit 1
          # fi

      # Upload Regression Results if Scheduled
      - name: Upload Stable Regression Testing Results
        # if: ${{ github.event_name == 'schedule' }} - temporarily comment this out to force a testing upload
        uses: actions/upload-artifact@v3
        with:
          name: stable-regression-results
          path: |
            test/regression/aromatics/chemkin/
            # test/regression/sulfur/chemkin

      # Retrieve Stable Results for reference
      - name: Retrieve Stable Regression Results
        if: ${{ github.event_name != 'schedule' }}
        uses: actions/download-artifact@v3
        with:
          name: stable-regression-results
          path: stable-results
          # should result in a set of folders, each of which has the stable result for that example/test

      # Regression Testing - Actual Comparisons
      - name: Regression Tests - Compare to Baseline
        if: ${{ github.event_name != 'schedule' }}
        env:
          REFERENCE: stable-results
        run: |
          python-jl scripts/checkModels.py \
          test/regression/aromatics \
          $REFERENCE/chem_annotated.inp \
          $REFERENCE/species_dictionary.txt \
          test/regression/aromatics/chemkin/chem_annotated.inp \
          test/regression/aromatics/chemkin/species_dictionary.txt

      # Install and Call codecov only if ALL the tests were successful
      - name: Code coverage install and run
        run: |
          mamba install -y -c conda-forge codecov
          codecov
